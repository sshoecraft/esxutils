#!/bin/bash
# for each vc server
while IFS=, read -r version cluster host server user
do
	# Get a list of all farms
	c=`echo $version | awk '{ print substr($0,1,1) }'`
	test "$c" = "#" && continue
	esxconf -s $server -u $user -t ClusterComputeResource -n | awk '{ print $2 }' > /tmp/farms
	while read obj
	do
#		echo "Farm obj: $obj"
		eval `esxconf -s $server -u $user -o $obj -e name`
		farm=$name

		# Get a list of all hosts in the farm
		esxconf -s $server -u $user -o $obj -t HostSystem host | awk '{ print $2 }' > /tmp/hosts
		while read obj
		do
#			echo "Host obj: $obj"
			eval `esxconf -s $server -u $user -o $obj -e name`
			host=$name

			# Get a list of all VMs on the host
			esxconf -s $server -u $user -o $obj -t VirtualMachine vm | awk '{ print $2 }' > /tmp/vms
			while read obj
			do
#				echo "VM obj: $obj"
				set -x
				eval `esxconf -s $server -u $user -o $obj -e name`
				vm=$name
				set +x

				esxconf -s $server -u $user -o $obj name config.hardware > /tmp/vminfo
				if test `cat /tmp/vminfo | grep sharedBus | grep -c physicalSharing` -gt 0; then
					echo $farm,$host,$vm
				fi
#break;
			done < /tmp/vms
#break;
		done < /tmp/hosts
#break;
	done < /tmp/farms
#break;
done < /usr/local/etc/vcservers
